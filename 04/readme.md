# PoW+PoS混合共识 
###1.PoW共识

  单一的 PoW 机制对能源的消耗很大，同时存在被攻击的风险。攻击者可以通过双花直接获得经济收益，或者通过执行 PoW-DoS 来勒索他人并要求更高的交易费用。此外，矿工以盈利为第一目标，对自身利益的考量往往会超过社区整体的利益。

###2.PoS共识

  PoS 的主要风险之一是过于中心化，大型节点的计算和验证能力将会胜过业余 PoS 矿工。通过PoS系统，PoW 数据中心所受到的特殊风险确实有所减少，但引入了新的中心化风险（大型权益持有人可能试图对系统进行控制）。另一个主要风险是由于黑名单“受污染”币而导致的可替代性侵蚀。

###3.PoW+PoS混合共识 

混合共识可以整合 PoW 和 PoS两种共识的优势，避免单一PoW或单一PoS机制的不足，形成安全效率兼顾、参与者利益平衡、环保持续的共识机制。

PoW+PoS 混合共识机制以通过激励PoS 节点，维持比纯 PoW 机制下更多的持续在线节点以此更有效地维持网络拓扑构结构的稳定性，从而一定程度上帮助抵御网络攻击。

PoW + PoS 混合共识赋予了权益持有人生成块的权力，如果攻击者希望在向网络广播之前实施双花，攻击者需要事先控制大量的权益。此外，通过相关机制选出的权益持有者来确定哪些交易应该包含在该区块中的规则能够提供一定安全性，以抵御试图通过拒绝交易来敲诈或破坏网络的攻击者。 

PoW + PoS 混合共识机制下，所有 PoW 产出的块都必须经过 PoS 的验证才能成为合法的块，即 PoW 负责出块 ，PoS 负责投票决定区块的有效性。矿工和持币者共同参与产块，二者互相制衡，这样就几乎杜绝了算力垄断的现象，确保了网络的安全。并且，PoW+PoS 混合共识机制，可以通过投票机制来有效控制硬分叉。 

PoW + PoS 的混合共识机制可以保护新用户的利益，防止早期投资者从 PoS 系统获得过多的奖励。通过PoS让中小投资者着眼于项目的中长期的发展，PoS会提高中小户的社区参与度，让他们更倾向于把币放在钱包里进行PoS而不是放在交易所随时准备交易。这会使得生态更加稳定和健康，人们会将注意力更多地放在技术与落地应用上，而不是仅仅关注短期的价格波动。同时，PoW机制也是对币价稳定的有力支撑，因为矿工通常都不会以低于成本价的价格出售币。

PoW + PoS 的混合共识机制的吞吐量依然不是太高,无法从根本上解决区块链的性能问题。

###4.PoW+PoS 混合共识机制的实现 

PoW+PoS 混合共识机制的基本实现逻辑是：

PoW 矿工创建区块；PoS 矿工确认这些区块的合法性。 

可以看到，PoW+PoS 混合共识机制可以解决矿工权力过大的问题，让区块链生态得到平衡发展，同时保障了网络的安全性。

###5.PoW+PoS 的实现过程 

1.挖矿过程将从 PoW 开始，矿工们竞相解决数学问题。根据哈希计算出块，被开采的块不包含任何交易。  

2.此时，系统将切换到 PoS，基于包含在该文件头中的信息，选择一组随机验证器来签署新区块。即通过 PoS 投票来决定 PoW 产块的合法性。将参与 PoS 投票的用户称之为验证者。在这里，验证者被选择的机会取决于验证者持有的代币数量。拥有的代币越多，该验证者被选中的概率就越高。验证者会选择将某个交易放入该块内。（与权益系统相关的交易被插入到UTXO中。） 

3.一旦这些选定的验证者完成区块签名，区块将成为一个完整的区块。如果某些验证程序不能用于签名块，它们将被选中用于签署下一个区块，并且将选择一组新的验证程序，直到当前块得到正确数量的签名为止。交易费用将分配给参与该区块签名的矿工和验证者。 

4.验证之后，将会有一个标志来指示前一个常规交易树（包含coinbase 和 non-stake 相关的交易）是否有效。然后系统切换到第二个PoW，将 PoS 的结果插入到新的 PoW 区块中，并设置标志（基于大部分验证）以确定前一个区块（特别是常规交易树）的有效性。如果前一个区块的常规交易树已经过验证，则将这些交易插入到 UTXO 集合中，然后重新启动整个过程。一般来说，PoW 和 PoS 的组合更像是一个彩票系统：验证者购买（锁定）一些代币作为票。票的持有者将有机会参与投票，决定是否在现有区块链上添加一个新区块，或者决定前一个常规交易树是否有效（包含coinbase 和 non-stake 相关的交易）。作为回报，奖励将发给 PoW 矿工和验证者（购买选票的代币也将返还）。如果验证失败，也就是说区块无法获得足够的投票，该区块将被丢弃，并且将区块内的交易信息返回到另一个区块中。 
 
具体的投票过程涉及到以下几个环节： 

<b>投票池</b>

为了使投票权相对公平，借鉴 DCR 的机制使用了投票池的概念。所有的票都被置于投票池中，投票池中的总票数是固定的，系统随机选择，选中者成功参与投票后，返还购买选票的费用。获得的出块奖励由参与的 PoW 矿工和 PoS 矿工共同获得。通过每隔 288 个区块进行票价调整，投票池里面总票数控制为 40960。

<b>购买票 </b>

投票池中的票是需要 HC 代币的持有者购买的，可以通过钱包直接购买票。总购票成本为选票价（Ticket price）加上 选票费（Ticket fee）,选票费是支付给 PoW 矿工的，是将票放入新挖区块的手续费。

<b>内存池 </b>

用于购买票的代币会被系统锁定，并且在投票完成前不可以撤回。刚买的票，需要被矿工打包记录在区块里才能生效，存放未被打包票的地方叫内存池（mempool）。内存池中，选票费高的更容易被矿工选中，可以更快地进入选票池（Ticket pool），因为每个新区块最多能记录的票数是有上限值的，所以内存池中的票存在竞争关系。 

<b>准选票 </b>
矿工打包完成，票在区块链中一经记录，这张票就成了准选票（immature ticket），也称之为未成熟选票。准选票可以理解为：它还不在选票池中，不具有被选中资格，同时选票费也无法退回，只能等待一定的时间进入选票池。如果内存池（mempool）中的票过多，经过一定时间没有被矿工打包记录，那么选票价（Ticket price）和选票费（Ticket fee）会被退回。这个和比特币交易打包很像，矿工费过低的数据包最终可能会被退回。 

<b>选票 </b>

成功进入选票池后，等待被系统选中，成为真正的选票，参与投票，拿到区块奖励。 系统随机决定，被选中的可能性服从泊松分布函数。简单来说，28 天内被选中的概率是 50%，142 天内被选中概率是 99.5%，如果 142 天仍然没能被选中，选票价将会退还，选票费已用于支付矿工验证的手续费，不予退还。 

# 参考文档
《HCASH黄皮书》


